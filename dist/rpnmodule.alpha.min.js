$(document).ready(function(){rpnsequence.init({debug:!0,mediapathformatter:function(d){return"/tests/medias/"+d}})});
var rpnmoduleLabels={en:{Recall:"Recall",Order:"Order",Warning:"Warning",BeforeUnloadMsg:"Module running!",Wait:"Wait please...",Validate:"Validate",Eraser:"Eraser",DragDropNotEmpty:"There are still some items to sort!",CardMazeNotEnded:"You have not finished the maze!",Sources:"Sources"},fr:{Recall:"Rappel",Order:"Consignes",Warning:"Attention",BeforeUnloadMsg:"Exercice en cours!",Wait:"Veuillez patienter...",Validate:"Valider",Eraser:"Effaceur",DragDropNotEmpty:"Il y a encore des \u00e9l\u00e9ments \u00e0 trier!",
CardMazeNotEnded:"Vous n'avez pas termin\u00e9 le labyrinthe!",Sources:"Sources"}},rpnmoduleSelectedLabels,rpnsequence=function(){var d,f,g,h,a,b,k,e,l,p,m,t,n,q=function(){$("body").append($('<div class="container" id="rpnm"><div class="row"><div class="col-md-12"><h1 id="rpnm_seq_title"></h1></div></div><div class="row"><div class="col-xs-8"><h2 id="rpnm_title"></h2><h3 id="rpnm_context"></h3><h4 id="rpnm_directive"></h4></div><div class="col-xs-4"><button class="btn btn-link" id="rpnm_recall_link" data-toggle="modal" data-target="#rpnm_recall_modal">'+
rpnmoduleSelectedLabels.Recall+'</button> <button class="btn btn-link"  id="rpnm_order_link" data-toggle="modal" data-target="#rpnm_order_modal">'+rpnmoduleSelectedLabels.Order+'</button></div></div><div class="row"><div id="rpnm_module_content" class="col-md-12"></div></div></div><div class="container"><div class="row"><div class="col-md-12"><em id="rpnm_source" class="pull-right"></em></div></div>'));$("body").append($('<div id="rpnm_recall_modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+
rpnmoduleSelectedLabels.Recall+'</h4></div><div class="modal-body"></div></div></div></div>'));$("body").append($('<div id="rpnm_order_modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+rpnmoduleSelectedLabels.Order+'</h4></div><div class="modal-body"></div></div></div></div>'));
$("body").append($('<div id="rpnm_alert_modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+rpnmoduleSelectedLabels.Warning+'</h4></div><div class="modal-body"></div></div></div></div>'));$("body").append($('<div id="rpnm_wait_modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 class="modal-title">'+
rpnmoduleSelectedLabels.Wait+'</h4></div><div class="modal-body"><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><span class="sr-only">100% completed</span></div></div></div></div></div></div>'));$("#rpnm_seq_title").html(d.title);h=$("#rpnm_source");g=$("#rpnm_module_content");t=$("#rpnm_alert_modal");_.each(d.modules,function(c,a){var e=$('<div class="rpnm_instance" id="rpnm_inst_'+
a+'">');g.append(e);"marker"==c.type?rpnmarkermodule().init(c,e):"mqc"==c.type?rpnmqcmodule().init(c,e):"gapsimple"==c.type?rpngapsimplemodule().init(c,e):"gapfull"==c.type?rpngapfullmodule().init(c,e):"clock"==c.type?rpnclockmodule().init(c,e):"blackbox"==c.type?rpnblackboxmodule().init(c,e):"dragdropsorting"==c.type?rpndragdropsortingmodule().init(c,e):"cardmaze"==c.type&&rpncardmazemodule().init(c,e);e.hide()});v();e&&$(window).bind("beforeunload",function(c){return rpnmoduleSelectedLabels.BeforeUnloadMsg});
r()},r=function(){$("#rpnm_wait_modal").modal("show");var c=d.modules[f];_.defaults(c,{title:"title"});$(".rpnm_instance").hide();var e=$("#rpnm_inst_"+f);$("#rpnm_title").show().text(c.title);_.isUndefined(c.context)?$("#rpnm_context").hide():$("#rpnm_context").show().text(c.context);_.isUndefined(c.directive)?$("#rpnm_directive").hide():$("#rpnm_directive").show().text(c.directive);_.isUndefined(c.recall)?$("#rpnm_recall_link").hide():($("#rpnm_recall_link").show(),$("#rpnm_recall_modal .modal-body").append(c.recall));
_.isUndefined(c.order)?$("#rpnm_order_link").hide():($("#rpnm_order_link").show(),$("#rpnm_order_modal .modal-body").html(c.order));h.html(_.isUndefined(c.sources)?"":rpnmoduleSelectedLabels.Sources+": "+c.sources);"ended"!=c.status?e.show():(f=u,0<=f?r():s());$("#rpnm_wait_modal").modal("hide")},u=function(){var c=_.find(d.modules,function(c){return"ended"!=c.status});return _.indexOf(d.modules,c)},s=function(){c("End of sequence");l(k);$.getJSON(a,function(a){var d=0;_.each(a.solutions,function(c,
e){d+=_.isUndefined(k[e])?0:k[e].correctionFct(k[e].responses,c)});c("Calculated total score for sequence "+d);e&&$(window).unbind("beforeunload");window.location=b})},c=function(c){n&&console.log(c)},v=function(){_.each($("img:not(.rpnm-img)"),function(c,e){var a=$(c);a.attr("src",m($(c).attr("src")));a.is(".modal-body img")&&a.addClass("img-responsive img-rounded")})};return{init:function(c){_.isUndefined(c)&&(c={});_.defaults(c,{sequrl:"seq.json",solurl:"sol.json",returnurl:"../",warnonexit:!1,
onsequenceend:function(){},onmoduleend:function(){},mediapathformatter:function(c){return"medias/"+c},language:"en",debug:!1});rpnmoduleSelectedLabels=rpnmoduleLabels[c.language];k=[];e=c.warnonexit;b=c.returnurl;a=c.solurl;n=c.debug;l=c.onsequenceend;p=c.onmoduleend;m=c.mediapathformatter;$.getJSON(c.sequrl,function(c){_.defaults(c,{title:"sequencetitle",modules:[]});d=c;_.each(d.modules,function(c,e){c.status="init"});f=0;q()})},buildUi:q,handleEndOfModule:function(e,a){c("End of module");k[f]=
{responses:e,correctionFct:a};$("#rpnm_wait_modal").modal("show");f++;p(e);_.isUndefined(d.modules[f])?s():r()},genericValidateButton:function(c){_.isUndefined(c);return $("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'))},displayAlert:function(c,e){$("#rpnm_alert_modal .modal-body").text(c);t.modal();t.on("hidden.bs.modal",function(){_.isUndefined(e)||e()})},log:c}}(),rpnmarkermodule=function(){var d,f,g,h,a,b=function(){f.addClass("marker");
var e=$("<div>",{"class":"btn-group","data-toggle":"buttons"}),b=_.shuffle(["primary","success","info","warning","danger"]);e.append($('<label class="btn btn-default active"><input type="radio" name="options" id="option1" autocomplete="off" checked><i class="glyphicon glyphicon-pencil"></i> '+rpnmoduleSelectedLabels.Eraser+"</label>").click(function(){g=-1}));$.each(d.markers,function(a,d){e.append($('<label class="btn btn-'+(b[a]||"default")+'"><input type="radio" name="options" id="option3" autocomplete="off"><i class="glyphicon glyphicon-pencil"></i> '+
d.label+"</label>").click(function(){g=d.val}))});f.append(e);f.append($('<div id="sentences">'+d.tomark+"</div>"));$.each($("#sentences b",f),function(e,d){a[e]=-1;var k=$(d);k.css("cursor","pointer").click(function(){k.removeClass();-1!=g&&k.addClass("marker-"+b[g]);a[e]=g})});h=$("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(h);k()},k=function(){h.click(function(){rpnsequence.handleEndOfModule(a,function(e,
a){var b=0;_.each(a,function(a,d){b+=e[d]==a?1:0});return b})})};return{init:function(e,k){_.defaults(e,{markers:[],tomark:["fill tomark to feel good please!"]});d=e;f=k;g=-1;a=[];b()}}},rpnmqcmodule=function(){var d,f,g,h,a=function(){f.addClass("mqc");var a=$("<ul>",{"class":"list-unstyled"});$.each(d.questions,function(e,b){h[e]=-1;var f=$("<li>");f.append($("<p>"+b.label+"</p>"));var g=$('<div class="btn-group" data-toggle="buttons">');$.each(d.answers,function(a,b){g.append($('<label class="btn btn-default"><input type="radio" name="question_'+
e+'" id="answer_'+e+"_"+a+'" autocomplete="off">'+b.label+"</label>").click(function(){h[e]=a}));f.append(g)});a.append(f)});f.append(a);g=rpnsequence.genericValidateButton();f.append(g);b()},b=function(){g.click(function(){rpnsequence.handleEndOfModule(h,function(a,e){var b=0;_.each(e,function(e,d){b+=a[d]==e?1:0});return b})})};return{init:function(b,e){_.defaults(b,{questions:["No questions!"],answers:["As no answers"]});d=b;f=e;h=[];a()}}},rpngapsimplemodule=function(){var d,f,g,h,a=function(){f.addClass("gapsimple");
f.append($('<div id="sentences" class="form-inline">'+d.tofill+"</div>"));$.each($("#sentences b",f),function(a,e){h[a]=-1;var b=$(e);b.replaceWith($('<input type="text" id="'+a+'" class="rpnm_input gapsimple form-control"> <strong>('+b.text()+")</strong>"))});g=rpnsequence.genericValidateButton();f.append(g);b()},b=function(){g.click(function(){$.each($(".gapsimple"),function(a,e){h[a]=$(e).val()});rpnsequence.handleEndOfModule(h,function(a,e){var b=0;_.each(e,function(e,d){b+=a[d]==e?1:0});return b})})};
return{init:function(b,e){_.defaults(b,{tofill:"tofill not set!<b>Read</b> documentation please!"});d=b;f=e;h=[];a()}}},rpngapfullmodule=function(){var d,f,g,h=function(){g.click(function(){rpnsequence.handleEndOfModule($("#gapfullresponse").val(),function(a,b){return a==b?1:0})})};return{init:function(a,b){_.defaults(a,{sentence:"sentence not set!"});d=a;f=b;f.addClass("gapfull");f.append($('<div id="sentences"><p>'+d.sentence+'</p><input type="text" id="gapfullresponse" class="rpnm_input form-control"></div>'));
$("#gapfullresponse").val(d.sentence);g=rpnsequence.genericValidateButton();f.append(g);h()}}},rpnclockmodule=function(){var d,f,g=function(){f.click(function(){rpnsequence.handleEndOfModule($("#gapfullresponse").val(),function(d,a){return d==a?1:0})})};return{init:function(h,a){d=a;d.addClass("clock");d.append($('<div id="rpnclock"></div>'));new ClockSelector("rpnclock",{background:"white",color_hour:"#333",color_minute:"#666",color_border:"#eee",highlight:"#357ebd"});f=rpnsequence.genericValidateButton();
d.append(f);g()}}},rpnblackboxmodule=function(){var d,f,g,h,a=function(){f.addClass("blackbox");var a=$('<div class="blackbox">');f.append(a);$.each(d.left,function(e,b){a.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><span>'+b+'</span></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+d.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><input type="text" id="'+e+'" class="rpnm_input blackbox-left form-control" style="text-align: center;"></div></div>'))});
$.each(d.right,function(e,b){a.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><input type="text" id="'+e+'" class="rpnm_input blackbox-right form-control" style="text-align: center;"></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+d.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><span>'+b+"</span></div></div>"))});g=rpnsequence.genericValidateButton();f.append(g);b()},b=
function(){g.click(function(){$.each($(".blackbox-left"),function(a,e){h.left[a]=$(e).val()});$.each($(".blackbox-right"),function(a,e){h.right[a]=$(e).val()});rpnsequence.handleEndOfModule(h,function(a,e){var b=0;_.each(e.right,function(e,d){b+=a.right[d]==e?1:0});_.each(e.left,function(e,d){b+=a.left[d]==e?1:0});return b})})};return{init:function(b,e){_.defaults(b,{inputtype:"number",fct:"x1",left:[1],right:[1]});d=b;f=e;h={left:[],right:[]};a()}}},rpndragdropsortingmodule=function(){var d,f,g,
h,a=function(){f.addClass("dragdropsorting");f.append($('<div class="row"><div class="container"><div class="col-md-12"><ul id="dragthis" class="list-unstyled"></ul></div></div><div class="row"><div class="container" id="dropzonecontainer"></div></div>'));$.each(d.todrop,function(a,b){$("#dropzonecontainer").append($('<div class="col-md-2"><ul class="droppable list-unstyled"><lh>'+b+"</lh></ul></div>"))});$("ul.droppable").sortable({group:"no-drop",onDrop:function(){b()}});g=rpnsequence.genericValidateButton();
f.append(g);k();b()},b=function(){if(0==$("#dragthis li").length&&0<d.todrag.length){var a=d.todrag.pop();$("#dragthis").append($("<li>"+a+"</li>"));$("#dragthis").sortable({group:"no-drop",drop:!1})}},k=function(){g.click(function(){0<d.todrag.length?rpnsequence.displayAlert(rpnmoduleSelectedLabels.DragDropNotEmpty):(_.each($(".droppable"),function(a,b){var d=[];$.each($(a).find("li"),function(a,b){d.push($(b).text())});h[$(a).find("lh").text()]=d}),rpnsequence.handleEndOfModule(h,function(a,b){var d=
0;_.map(b,function(b,k){d+=_.intersection(a[k],b).length});return d}))})};return{init:function(b,k){_.defaults(b,{todrag:["empty"],todrop:["empty too :'("]});d=b;f=k;h=[];a()}}},rpncardmazemodule=function(){var d,f,g,h,a,b,k,e,l,p=function(){f.addClass("cardmaze");f.append($('<div class="row"><div class="container" id="maze"></div></div>'));_.each(d.cards,function(b,e){$("#maze").append($('<div class="col-xs-2"><div class="card'+(b.start?" start selectable":"")+(b.end?" end":"")+'"><p>'+b.label+"</p><p>"+
b.clue+"</p></div></div>"));b.start&&(a=e);b.end&&(l=e)});g=rpnsequence.genericValidateButton();f.append(g);m()},m=function(){_.each($(".card"),function(d,f){$(d).click(function(){!$(d).hasClass("selectable")||(f!=a&&f!=a+k&&f!=a-k&&f!=a-1&&f!=a+1||$(d).hasClass("selected"))||(a!=f&&e.push(d),a=f,$(".snakehead").removeClass("snakehead"),$(d).addClass("selected snakehead"),$(".selectable").removeClass("selectable"),f!=l&&(f+k>k*b||$($(".card")[f+k]).addClass("selectable"),0>f-k||$($(".card")[f-k]).addClass("selectable"),
0!=f%k&&$($(".card")[f-1]).addClass("selectable"),0!=(f+1)%k&&$($(".card")[f+1]).addClass("selectable")),h.push(f))})});g.click(function(){$(e[e.length-1]).hasClass("end")?rpnsequence.handleEndOfModule(h,function(b,a){var e=0;_.each(a,function(a,d){e+=b[d]==a?1:0});return e}):rpnsequence.displayAlert(rpnmoduleSelectedLabels.CardMazeNotEnded)})};return{init:function(a,g){_.defaults(a,{mazewidth:6,mazeheight:4,cards:[{label:"label",clue:"clue"}]});d=a;b=d.mazeheight;k=d.mazewidth;f=g;h=[];p();e=[]}}};
function ClockSelector(d,f){var g={auto_dt:1E3,automate:!0,background:"black",callback:function(){},color_border:"#fff",color_hour:"#fff",color_minute:"#aaa",draw_hour:null,draw_minute:null,draw_second:null,highlight:"#f93",manual:!0,stroke_border:3,stroke_hour:2,stroke_minute:0.75,scale_hour:0.5,scale_border:0.8,scale_minute:0.65},h;for(h in g)this[h]=f&&h in f?f[h]:g[h];d=document.getElementById(d);this.size=Math.min(d.width,d.height);this.size||(g=window.getComputedStyle(d),this.size=Math.min(parseInt(g.width),
parseInt(g.height)));"CANVAS"!=d.tagName&&(d.appendChild(document.createElement("canvas")),d=d.childNodes[d.childNodes.length-1],d.width=this.size,d.height=this.size);this.canvas=d;this.context=d.getContext("2d");this.dragging=!1;this.time=null;this.color_mindef=this.color_minute;d.style.backgroundColor=this.background;ClockSelector.prototype.clockTime=function(){return this.time};ClockSelector.prototype.drawHand=function(a,b,d){var e=this.context;e.strokeStyle=a;e.fillStyle=a;e.lineWidth=b;e.beginPath();
e.moveTo(0,0);e.lineTo(0,100*d);e.closePath();e.stroke();e.arc(0,0,b/2,0,2*Math.PI);e.fill()};ClockSelector.prototype.getCanvasOffset=function(){for(var a=[0,0],b=this.canvas;b.offsetParent;)a[0]+=b.offsetLeft,a[1]+=b.offsetTop,b=b.offsetParent;return a};ClockSelector.prototype.reset=function(){this.setTime(new Date);this.automate&&(this.timeout=setInterval(this.setTimeRecurring(),this.auto_dt))};ClockSelector.prototype.setParam=function(a,b){a in this&&(this[a]=b)};ClockSelector.prototype.setTime=
function(a){this.canvas.width=this.canvas.width;this.time=a;a=a.getTime()/1E3-60*a.getTimezoneOffset();var b=this.context,d=this.size/200,e=a%3600/1800*Math.PI,f=a/21600*Math.PI;this.setTransform(b,a%60/30*Math.PI,d);this.draw_second&&(a=this.draw_second,a(b));this.setTransform(b,e,d);this.draw_minute?(a=this.draw_minute,a(b)):this.drawHand(this.color_minute,2*this.stroke_minute,this.scale_minute);this.setTransform(b,f,d);this.draw_hour?(a=this.drawHour,a(b)):this.drawHand(this.color_hour,2*this.stroke_hour,
this.scale_hour);b.setTransform(d,0,0,d,100*d,100*d);b.strokeStyle=this.color_border;b.lineWidth=2*this.stroke_border;b.beginPath();b.arc(0,0,100*this.scale_border,0,2*Math.PI);b.stroke();b.closePath();this.callback&&this.callback(this)};ClockSelector.prototype.setTimeFromEvent=function(a){var b=this.getCanvasOffset(),d=a.pageX-b[0]-this.size/2;a=this.size/2-(a.pageY-b[1]);if(0!=d||0!=a){d=Math.atan2(a,d);if(this.drag_minute){var e=(75-30*d/Math.PI)%60,f=this.time.getMinutes()+this.time.getSeconds()/
60;a=this.time.getHours();b=e;e<f&&30>=f-e||(e<f&&30<f-e?a+=1:e>f&&30>=e-f||e>f&&30<e-f&&(a-=1));a=(a+24)%24}else a=3-6*d/Math.PI,b=this.time.getHours()+this.time.getMinutes()/60+this.time.getSeconds()/3600,a+=a<b?24:0,a=((a<b+6?a:a<b+12?a-12:a<b+18?a+12:a)+24)%24,b=(60*(3-6*d/Math.PI)%60+60)%60;e=new Date;e.setHours(a);e.setMinutes(b);e.setSeconds((3600*(3-6*d/Math.PI)%60+60)%60);this.setTime(e)}};ClockSelector.prototype.setTimeRecurring=function(){var a=this;return function(){a.setTime(new Date)}};
ClockSelector.prototype.setTransform=function(a,b,d){a.setTransform(-d*Math.cos(b),-d*Math.sin(b),d*Math.sin(b),-d*Math.cos(b),100*d,100*d)};ClockSelector.prototype.makeEndDrag=function(){var a=this;return function(){a.color_minute=a.color_mindef;a.dragging=!1;a.setTime(a.clockTime())}};ClockSelector.prototype.makeSetTime=function(a){if(this.manual){var b=this;return function(){var d=window.event,e=b.getCanvasOffset(),f=d.pageX-e[0]-b.size/2,d=b.size/2-(d.pageY-e[1]);b.manual&&(b.canvas.style.cursor=
Math.sqrt(f*f+d*d)<=(b.size*b.scale_border+b.stroke_border)/2?"pointer":"default");if(b.dragging!=a){if(a&&!b.dragging){var e=30*(Math.atan2(f,d)+2*Math.PI)/Math.PI,g=[(e+57.5)%60,(e+2.5)%60],e=b.clockTime().getMinutes()+b.clockTime().getSeconds()/60;Math.sqrt(f*f+d*d)<b.size/2*b.scale_border&&(g[0]<e&&e<g[1]||e<g[0]&&g[1]<g[0]&&e<g[1]||g[0]<e&&g[1]<e&&g[1]<g[0])?b.color_minute!=b.highlight&&(b.color_minute=b.highlight,b.drag_minute=!0,b.setTime(b.clockTime())):b.color_minute!=b.color_mindef&&(b.color_minute=
b.color_mindef,b.drag_minute=!1,b.setTime(b.clockTime()))}}else b.dragging||a||(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),b.dragging=!0),b.setTimeFromEvent(window.event)}}};this.manual&&(this.canvas.onmousedown=this.makeSetTime(!1),this.canvas.onmouseup=this.makeEndDrag(),this.canvas.onmouseout=this.makeEndDrag(),this.canvas.onmousemove=this.makeSetTime(!0));this.reset()}
!function(d,f,g,h){function a(c,d){var b=Math.max(0,c[0]-d[0],d[0]-c[1]),a=Math.max(0,c[2]-d[1],d[1]-c[3]);return b+a}function b(c,b,a,e){var f=c.length;e=e?"offset":"position";for(a=a||0;f--;){var g=c[f].el?c[f].el:d(c[f]),h=g[e]();h.left+=parseInt(g.css("margin-left"),10);h.top+=parseInt(g.css("margin-top"),10);b[f]=[h.left-a,h.left+g.outerWidth()+a,h.top-a,h.top+g.outerHeight()+a]}}function k(c,a){var d=a.offset();return{left:c.left-d.left,top:c.top-d.top}}function e(c,d,b){d=[d.left,d.top];b=
b&&[b.left,b.top];for(var e,f=c.length,g=[];f--;)e=c[f],g[f]=[f,a(e,d),b&&a(e,b)];return g=g.sort(function(c,d){return d[1]-c[1]||d[2]-c[2]||d[0]-c[0]})}function l(c){this.options=d.extend({},n,c);this.containers=[];this.options.rootGroup||(this.scrollProxy=d.proxy(this.scroll,this),this.dragProxy=d.proxy(this.drag,this),this.dropProxy=d.proxy(this.drop,this),this.placeholder=d(this.options.placeholder),c.isValidTarget||(this.options.isValidTarget=h))}function p(c,b){this.el=c;this.options=d.extend({},
t,b);this.group=l.get(this.options);this.rootGroup=this.options.rootGroup||this.group;this.handle=this.rootGroup.options.handle||this.rootGroup.options.itemSelector;var a=this.rootGroup.options.itemPath;this.target=a?this.el.find(a):this.el;this.target.on(m.start,this.handle,d.proxy(this.dragInit,this));this.options.drop&&this.group.containers.push(this)}var m,t={drag:!0,drop:!0,exclude:"",nested:!0,vertical:!0},n={afterMove:function(c,d,a){},containerPath:"",containerSelector:"ol, ul",distance:0,
delay:0,handle:"",itemPath:"",itemSelector:"li",isValidTarget:function(c,d){return!0},onCancel:function(c,d,a,b){},onDrag:function(c,d,a,b){c.css(d)},onDragStart:function(c,a,b,e){c.css({height:c.height(),width:c.width()});c.addClass("dragged");d("body").addClass("dragging")},onDrop:function(c,a,b,e){c.removeClass("dragged").removeAttr("style");d("body").removeClass("dragging")},onMousedown:function(c,d,a){if(!a.target.nodeName.match(/^(input|select)$/i))return a.preventDefault(),!0},placeholder:'<li class="placeholder"/>',
pullPlaceholder:!0,serialize:function(c,a,b){c=d.extend({},c.data());if(b)return[a];a[0]&&(c.children=a);delete c.subContainers;delete c.sortable;return c},tolerance:0},q={},r=0,u={left:0,top:0,bottom:0,right:0};m={start:"touchstart.sortable mousedown.sortable",drop:"touchend.sortable touchcancel.sortable mouseup.sortable",drag:"touchmove.sortable mousemove.sortable",scroll:"scroll.sortable"};l.get=function(c){q[c.group]||(c.group===h&&(c.group=r++),q[c.group]=new l(c));return q[c.group]};l.prototype=
{dragInit:function(c,a){this.$document=d(a.el[0].ownerDocument);this.item=d(c.target).closest(this.options.itemSelector);this.itemContainer=a;!this.item.is(this.options.exclude)&&this.options.onMousedown(this.item,n.onMousedown,c)&&(this.setPointer(c),this.toggleListeners("on"),this.setupDelayTimer(),this.dragInitDone=!0)},drag:function(c){if(!this.dragging){if(!this.distanceMet(c)||!this.delayMet)return;this.options.onDragStart(this.item,this.itemContainer,n.onDragStart,c);this.item.before(this.placeholder);
this.dragging=!0}this.setPointer(c);this.options.onDrag(this.item,k(this.pointer,this.item.offsetParent()),n.onDrag,c);var a=c.pageX||c.originalEvent.pageX;c=c.pageY||c.originalEvent.pageY;var d=this.sameResultBox,b=this.options.tolerance;if(!d||d.top-b>c||d.bottom+b<c||d.left-b>a||d.right+b<a)this.searchValidTarget()||this.placeholder.detach()},drop:function(c){this.toggleListeners("off");this.dragInitDone=!1;if(this.dragging){if(this.placeholder.closest("html")[0])this.placeholder.before(this.item).detach();
else this.options.onCancel(this.item,this.itemContainer,n.onCancel,c);this.options.onDrop(this.item,this.getContainer(this.item),n.onDrop,c);this.clearDimensions();this.clearOffsetParent();this.lastAppendedItem=this.sameResultBox=h;this.dragging=!1}},searchValidTarget:function(c,a){c||(c=this.relativePointer||this.pointer,a=this.lastRelativePointer||this.lastPointer);for(var d=e(this.getContainerDimensions(),c,a),b=d.length;b--;){var f=d[b][0];if(!d[b][1]||this.options.pullPlaceholder)if(f=this.containers[f],
!f.disabled){if(!this.$getOffsetParent()){var g=f.getItemOffsetParent();c=k(c,g);a=k(a,g)}if(f.searchValidTarget(c,a))return!0}}this.sameResultBox&&(this.sameResultBox=h)},movePlaceholder:function(c,a,d,b){var e=this.lastAppendedItem;if(b||!e||e[0]!==a[0])a[d](this.placeholder),this.lastAppendedItem=a,this.sameResultBox=b,this.options.afterMove(this.placeholder,c,a)},getContainerDimensions:function(){this.containerDimensions||b(this.containers,this.containerDimensions=[],this.options.tolerance,!this.$getOffsetParent());
return this.containerDimensions},getContainer:function(c){return c.closest(this.options.containerSelector).data(g)},$getOffsetParent:function(){if(this.offsetParent===h){var c=this.containers.length-1,a=this.containers[c].getItemOffsetParent();if(!this.options.rootGroup)for(;c--;)if(a[0]!=this.containers[c].getItemOffsetParent()[0]){a=!1;break}this.offsetParent=a}return this.offsetParent},setPointer:function(c){c=this.getPointer(c);if(this.$getOffsetParent()){var a=k(c,this.$getOffsetParent());this.lastRelativePointer=
this.relativePointer;this.relativePointer=a}this.lastPointer=this.pointer;this.pointer=c},distanceMet:function(c){c=this.getPointer(c);return Math.max(Math.abs(this.pointer.left-c.left),Math.abs(this.pointer.top-c.top))>=this.options.distance},getPointer:function(c){return{left:c.pageX||c.originalEvent.pageX,top:c.pageY||c.originalEvent.pageY}},setupDelayTimer:function(){var c=this;this.delayMet=!this.options.delay;this.delayMet||(clearTimeout(this._mouseDelayTimer),this._mouseDelayTimer=setTimeout(function(){c.delayMet=
!0},this.options.delay))},scroll:function(c){this.clearDimensions();this.clearOffsetParent()},toggleListeners:function(c){var a=this;d.each(["drag","drop","scroll"],function(d,b){a.$document[c](m[b],a[b+"Proxy"])})},clearOffsetParent:function(){this.offsetParent=h},clearDimensions:function(){this.traverse(function(c){c._clearDimensions()})},traverse:function(c){c(this);for(var a=this.containers.length;a--;)this.containers[a].traverse(c)},_clearDimensions:function(){this.containerDimensions=h},_destroy:function(){q[this.options.group]=
h}};p.prototype={dragInit:function(c){var a=this.rootGroup;!this.disabled&&(!a.dragInitDone&&this.options.drag&&this.isValidDrag(c))&&a.dragInit(c,this)},isValidDrag:function(c){return 1==c.which||"touchstart"==c.type&&1==c.originalEvent.touches.length},searchValidTarget:function(c,a){var d=e(this.getItemDimensions(),c,a),b=d.length,f=this.rootGroup,g=!f.options.isValidTarget||f.options.isValidTarget(f.item,this);if(!b&&g)return f.movePlaceholder(this,this.target,"append"),!0;for(;b--;)if(f=d[b][0],
!d[b][1]&&this.hasChildGroup(f)){if(this.getContainerGroup(f).searchValidTarget(c,a))return!0}else if(g)return this.movePlaceholder(f,c),!0},movePlaceholder:function(c,a){var b=d(this.items[c]),e=this.itemDimensions[c],f="after",g=b.outerWidth(),h=b.outerHeight(),k=b.offset(),k={left:k.left,right:k.left+g,top:k.top,bottom:k.top+h};this.options.vertical?a.top<=(e[2]+e[3])/2?(f="before",k.bottom-=h/2):k.top+=h/2:a.left<=(e[0]+e[1])/2?(f="before",k.right-=g/2):k.left+=g/2;this.hasChildGroup(c)&&(k=u);
this.rootGroup.movePlaceholder(this,b,f,k)},getItemDimensions:function(){this.itemDimensions||(this.items=this.$getChildren(this.el,"item").filter(":not(.placeholder, .dragged)").get(),b(this.items,this.itemDimensions=[],this.options.tolerance));return this.itemDimensions},getItemOffsetParent:function(){var c=this.el;return"relative"===c.css("position")||"absolute"===c.css("position")||"fixed"===c.css("position")?c:c.offsetParent()},hasChildGroup:function(c){return this.options.nested&&this.getContainerGroup(c)},
getContainerGroup:function(c){var a=d.data(this.items[c],"subContainers");if(a===h){var b=this.$getChildren(this.items[c],"container"),a=!1;b[0]&&(a=d.extend({},this.options,{rootGroup:this.rootGroup,group:r++}),a=b[g](a).data(g).group);d.data(this.items[c],"subContainers",a)}return a},$getChildren:function(c,a){var b=this.rootGroup.options,e=b[a+"Path"],b=b[a+"Selector"];c=d(c);e&&(c=c.find(e));return c.children(b)},_serialize:function(c,a){var b=this,e=this.$getChildren(c,a?"item":"container").not(this.options.exclude).map(function(){return b._serialize(d(this),
!a)}).get();return this.rootGroup.options.serialize(c,e,a)},traverse:function(a){d.each(this.items||[],function(b){(b=d.data(this,"subContainers"))&&b.traverse(a)});a(this)},_clearDimensions:function(){this.itemDimensions=h},_destroy:function(){var a=this;this.target.off(m.start,this.handle);this.el.removeData(g);this.options.drop&&(this.group.containers=d.grep(this.group.containers,function(b){return b!=a}));d.each(this.items||[],function(){d.removeData(this,"subContainers")})}};var s={enable:function(){this.traverse(function(a){a.disabled=
!1})},disable:function(){this.traverse(function(a){a.disabled=!0})},serialize:function(){return this._serialize(this.el,!0)},refresh:function(){this.traverse(function(a){a._clearDimensions()})},destroy:function(){this.traverse(function(a){a._destroy()})}};d.extend(p.prototype,s);d.fn[g]=function(a){var b=Array.prototype.slice.call(arguments,1);return this.map(function(){var e=d(this),f=e.data(g);if(f&&s[a])return s[a].apply(f,b)||this;f||a!==h&&"object"!==typeof a||e.data(g,new p(e,a));return this})}}(jQuery,
window,"sortable");
