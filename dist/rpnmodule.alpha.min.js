$(document).ready(function(){rpnmodule.init({moduleend:function(e){alert("module ended!"+e)}})});
var rpnmoduleLabels={en:{Recall:"Recall",Order:"Order",Warning:"Warning",BeforeUnloadMsg:"Module running!",Wait:"Wait please...",Validate:"Validate",Eraser:"Eraser"},fr:{Recall:"Rappel",Order:"Consignes",Warning:"Attention",BeforeUnloadMsg:"Exercice en cours!",Wait:"Veuillez patienter...",Validate:"Valider",Eraser:"Effaceur"}},rpnmoduleSelectedLabels,rpnmodule=function(){var e,f,c,g,b,a,k,d,h,m=function(){$("body").append($('<div class="container"><div class="row"><div class="col-md-12"><h1 id="sequenceTitle"></h1></div></div><div class="row"><div class="col-xs-8"><h2 id="moduleTitle"></h2><h3 id="moduleContext"></h3><h4 id="moduleDirective"></h4></div><div class="col-xs-4"><button class="btn btn-link" id="recallLink" data-toggle="modal" data-target="#recallModal">'+rpnmoduleSelectedLabels.Recall+
'</button> <button class="btn btn-link"  id="orderLink" data-toggle="modal" data-target="#orderModal">'+rpnmoduleSelectedLabels.Order+'</button></div></div><div class="row"><div id="mainContent" class="col-md-12"></div></div></div>'));$("body").append($('<div id="recallModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+
rpnmoduleSelectedLabels.Recall+'</h4></div><div class="modal-body" id="recallModalContent"></div></div></div></div>'));$("body").append($('<div id="orderModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+rpnmoduleSelectedLabels.Order+
'</h4></div><div class="modal-body" id="orderModalContent"></div></div></div></div>'));$("body").append($('<div id="alertModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">'+rpnmoduleSelectedLabels.Warning+'</h4></div><div class="modal-body" id="orderModalContent"></div></div></div></div>'));
$("body").append($('<div id="waitModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 class="modal-title">'+rpnmoduleSelectedLabels.Wait+'</h4></div><div class="modal-body" id="orderModalContent"><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><span class="sr-only">100% completed</span></div></div></div></div></div></div>'));
$("#sequenceTitle").html(e.title);c=$("#mainContent");k&&$(window).bind("beforeunload",function(a){return rpnmoduleSelectedLabels.BeforeUnloadMsg});l()},l=function(){var a=e.modules[f];_.defaults(a,{title:"title"});c.empty();c.removeClass().addClass("col-md-12");$("#moduleTitle").show().text(a.title);_.isUndefined(a.context)?$("#moduleContext").hide():$("#moduleContext").show().text(a.context);_.isUndefined(a.directive)?$("#moduleDirective").hide():$("#moduleDirective").show().text(a.directive);$("#waitModal").modal("hide");
"marker"==a.type?rpnmarkermodule.init(a,c):"mqc"==a.type?rpnmqcmodule.init(a,c):"gapsimple"==a.type?rpngapsimplemodule.init(a,c):"gapfull"==a.type?rpngapfullmodule.init(a,c):"clock"==a.type?rpnclockmodule.init(a,c):"blackbox"==a.type?rpnblackboxmodule.init(a,c):"rpndraganddropsorting"==a.type&&rpndraganddropsorting.init(a,c)},n=function(){d(a);$.getJSON(g,function(d){var h=0;_.each(d.solutions,function(d,b){h+=_.isUndefined(a[b])?0:a[b].correctionFct(a[b].responses,d)});k&&$(window).unbind("beforeunload");
window.location=b})};return{init:function(c){_.defaults(c,{sequrl:"seq.json",solurl:"sol.json",mediaurl:"medias",returnurl:"../",warnonexit:!1,onsequenceend:function(){},onmoduleend:function(){},language:"en"});rpnmoduleSelectedLabels=rpnmoduleLabels[c.language];a=[];k=c.warnonexit;b=c.returnurl;g=c.solurl;d=c.onsequenceend;h=c.onmoduleend;$.getJSON(c.sequrl,function(a){_.defaults(a,{title:"mqc",modules:[]});e=a;f=0;m()})},buildUi:m,handleEndOfModule:function(d,b){a[f]={responses:d,correctionFct:b};
$("#waitModal").modal("show");f++;h(d);_.isUndefined(e.modules[f])?n():l()}}}(),rpnmarkermodule=function(){var e,f,c,g,b,a=function(){f.addClass("rpnmodule_marker");var a=$("<div>",{"class":"btn-group","data-toggle":"buttons"}),h=_.shuffle(["primary","success","info","warning","danger"]);a.append($('<label class="btn btn-default active"><input type="radio" name="options" id="option1" autocomplete="off" checked><i class="glyphicon glyphicon-pencil"></i> '+rpnmoduleSelectedLabels.Eraser+"</label>").click(function(){c=
-1}));$.each(e.markers,function(b,k){a.append($('<label class="btn btn-'+(h[b]||"default")+'"><input type="radio" name="options" id="option3" autocomplete="off"><i class="glyphicon glyphicon-pencil"></i> '+k.label+"</label>").click(function(){c=k.val}))});f.append(a);f.append($('<div id="sentences">'+e.tomark+"</div>"));$.each($("#sentences b"),function(a,d){b[a]=-1;var k=$(d);k.css("cursor","pointer").click(function(){k.removeClass();-1!=c&&k.addClass("marker-"+h[c]);b[a]=c})});g=$("<button>",{"class":"btn btn-primary",
text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(g);k()},k=function(){g.click(function(){rpnmodule.handleEndOfModule(b,function(a,b){var k=0;_.each(b,function(b,h){k+=a[h]==b?1:0});return k})})};return{init:function(d,k){e=d;f=k;c=-1;b=[];a()}}}(),rpnmqcmodule=function(){var e,f,c,g,b=function(){f.addClass("rpnmodule_mqc");var b=$("<ul>",{"class":"list-unstyled"});$.each(e.questions,function(a,h){g[a]=-1;var c=$("<li>");c.append($("<p>"+h.label+
"</p>"));var f=$('<div class="btn-group" data-toggle="buttons">');$.each(e.answers,function(b,k){f.append($('<label class="btn btn-default"><input type="radio" name="question_'+a+'" id="answer_'+a+"_"+b+'" autocomplete="off">'+k.label+"</label>").click(function(){g[a]=b}));c.append(f)});b.append(c)});f.append(b);c=$("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(c);a()},a=function(){c.click(function(){rpnmodule.handleEndOfModule(g,
function(a,b){var h=0;_.each(b,function(b,d){h+=a[d]==b?1:0});return h})})};return{init:function(a,d){e=a;f=d;g=[];b()}}}(),rpngapsimplemodule=function(){var e,f,c,g,b=function(){f.addClass("rpnmodule_gapsimple");f.append($('<div id="sentences" class="form-inline">'+e.tofill+"</div>"));$.each($("#sentences b"),function(a,b){g[a]=-1;var h=$(b);h.replaceWith($('<input type="text" id="'+a+'" class="rpnmodule-input gapsimple form-control"> <strong>('+h.text()+")</strong>"))});c=$("<button>",{"class":"btn btn-primary",
text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(c);a()},a=function(){c.click(function(){$.each($(".gapsimple"),function(a,b){g[a]=$(b).val()});rpnmodule.handleEndOfModule(g,function(a,b){var h=0;_.each(b,function(b,d){h+=a[d]==b?1:0});return h})})};return{init:function(a,d){e=a;f=d;g=[];b()}}}(),rpngapfullmodule=function(){var e,f,c,g=function(){c.click(function(){rpnmodule.handleEndOfModule($("#gapfullresponse").val(),function(b,a){return b==
a?1:0})})};return{init:function(b,a){e=b;f=a;f.addClass("rpnmodule_gapfull");f.append($('<div id="sentences"><p>'+e.sentence+'</p><input type="text" id="gapfullresponse" class="rpnmodule-input form-control"></div>'));$("#gapfullresponse").val(e.sentence);c=$("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(c);g()}}}(),rpnclockmodule=function(){var e,f,c=function(){f.click(function(){rpnmodule.handleEndOfModule($("#gapfullresponse").val(),
function(c,b){return c==b?1:0})})};return{init:function(g,b){e=b;e.addClass("rpnmodule_clock");e.append($('<div id="rpnclock"></div>'));new ClockSelector("rpnclock",{background:"white",color_hour:"#333",color_minute:"#666",color_border:"#eee",highlight:"#357ebd"});f=$("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));e.append(f);c()}}}(),rpnblackboxmodule=function(){var e,f,c,g,b=function(){f.addClass("rpnmodule_blackbox");
var b=$('<div class="blackbox">');f.append(b);$.each(e.left,function(a,c){b.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><span>'+c+'</span></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+e.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><input type="text" id="'+a+'" class="rpnmodule-input blackbox-left form-control" style="text-align: center;"></div></div>'))});$.each(e.right,
function(a,c){b.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><input type="text" id="'+a+'" class="rpnmodule-input blackbox-right form-control" style="text-align: center;"></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+e.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><span>'+c+"</span></div></div>"))});c=$("<button>",{"class":"btn btn-primary",text:" "+rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));
f.append(c);a()},a=function(){c.click(function(){$.each($(".blackbox-left"),function(a,b){g.left[a]=$(b).val()});$.each($(".blackbox-right"),function(a,b){g.right[a]=$(b).val()});rpnmodule.handleEndOfModule(g,function(a,b){var c=0;_.each(b.right,function(b,d){c+=a.right[d]==b?1:0});_.each(b.left,function(b,d){c+=a.left[d]==b?1:0});return c})})};return{init:function(a,d){_.defaults(a,{inputtype:"number",fct:"x1",left:[1],right:[1]});e=a;f=d;g={left:[],right:[]};b()}}}(),rpndraganddropsorting=function(){var e,
f,c,g,b=function(){f.addClass("rpnmodule_blackbox");var b=$('<div class="blackbox">');f.append(b);$.each(e.left,function(a,c){b.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><span>'+c+'</span></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+e.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><input type="text" id="'+a+'" class="rpnmodule-input blackbox-left form-control" style="text-align: center;"></div></div>'))});
$.each(e.right,function(a,c){b.append($('<div class="row"><div class="col-md-3 hidden-xs hidden-sm"></div><div class="col-xs-2"><input type="text" id="'+a+'" class="rpnmodule-input blackbox-right form-control" style="text-align: center;"></div><div class="col-xs-2 blackbox-fct"><i class="glyphicon glyphicon-minus"></i> ('+e.operation+') <i class="glyphicon glyphicon-arrow-right"></i></div><div class="col-xs-2"><span>'+c+"</span></div></div>"))});c=$("<button>",{"class":"btn btn-primary",text:" "+
rpnmoduleSelectedLabels.Validate}).prepend($('<i class="glyphicon glyphicon-ok"></i>'));f.append(c);a()},a=function(){c.click(function(){$.each($(".blackbox-left"),function(a,b){g.left[a]=$(b).val()});$.each($(".blackbox-right"),function(a,b){g.right[a]=$(b).val()});rpnmodule.handleEndOfModule(g,function(a,b){var c=0;_.each(b.right,function(b,d){c+=a.right[d]==b?1:0});_.each(b.left,function(b,d){c+=a.left[d]==b?1:0});return c})})};return{init:function(a,c){_.defaults(a,{inputtype:"number",fct:"x1",
left:[1],right:[1]});e=a;f=c;g={left:[],right:[]};b()}}}();
function ClockSelector(e,f){var c={auto_dt:1E3,automate:!0,background:"black",callback:function(){},color_border:"#fff",color_hour:"#fff",color_minute:"#aaa",draw_hour:null,draw_minute:null,draw_second:null,highlight:"#f93",manual:!0,stroke_border:3,stroke_hour:2,stroke_minute:0.75,scale_hour:0.5,scale_border:0.8,scale_minute:0.65},g;for(g in c)this[g]=f&&g in f?f[g]:c[g];e=document.getElementById(e);this.size=Math.min(e.width,e.height);this.size||(c=window.getComputedStyle(e),this.size=Math.min(parseInt(c.width),
parseInt(c.height)));"CANVAS"!=e.tagName&&(e.appendChild(document.createElement("canvas")),e=e.childNodes[e.childNodes.length-1],e.width=this.size,e.height=this.size);this.canvas=e;this.context=e.getContext("2d");this.dragging=!1;this.time=null;this.color_mindef=this.color_minute;e.style.backgroundColor=this.background;ClockSelector.prototype.clockTime=function(){return this.time};ClockSelector.prototype.drawHand=function(b,a,c){var d=this.context;d.strokeStyle=b;d.fillStyle=b;d.lineWidth=a;d.beginPath();
d.moveTo(0,0);d.lineTo(0,100*c);d.closePath();d.stroke();d.arc(0,0,a/2,0,2*Math.PI);d.fill()};ClockSelector.prototype.getCanvasOffset=function(){for(var b=[0,0],a=this.canvas;a.offsetParent;)b[0]+=a.offsetLeft,b[1]+=a.offsetTop,a=a.offsetParent;return b};ClockSelector.prototype.reset=function(){this.setTime(new Date);this.automate&&(this.timeout=setInterval(this.setTimeRecurring(),this.auto_dt))};ClockSelector.prototype.setParam=function(b,a){b in this&&(this[b]=a)};ClockSelector.prototype.setTime=
function(b){this.canvas.width=this.canvas.width;this.time=b;b=b.getTime()/1E3-60*b.getTimezoneOffset();var a=this.context,c=this.size/200,d=b%3600/1800*Math.PI,e=b/21600*Math.PI;this.setTransform(a,b%60/30*Math.PI,c);this.draw_second&&(b=this.draw_second,b(a));this.setTransform(a,d,c);this.draw_minute?(b=this.draw_minute,b(a)):this.drawHand(this.color_minute,2*this.stroke_minute,this.scale_minute);this.setTransform(a,e,c);this.draw_hour?(b=this.drawHour,b(a)):this.drawHand(this.color_hour,2*this.stroke_hour,
this.scale_hour);a.setTransform(c,0,0,c,100*c,100*c);a.strokeStyle=this.color_border;a.lineWidth=2*this.stroke_border;a.beginPath();a.arc(0,0,100*this.scale_border,0,2*Math.PI);a.stroke();a.closePath();this.callback&&this.callback(this)};ClockSelector.prototype.setTimeFromEvent=function(b){var a=this.getCanvasOffset(),c=b.pageX-a[0]-this.size/2;b=this.size/2-(b.pageY-a[1]);if(0!=c||0!=b){c=Math.atan2(b,c);if(this.drag_minute){var d=(75-30*c/Math.PI)%60,e=this.time.getMinutes()+this.time.getSeconds()/
60;b=this.time.getHours();a=d;d<e&&30>=e-d||(d<e&&30<e-d?b+=1:d>e&&30>=d-e||d>e&&30<d-e&&(b-=1));b=(b+24)%24}else b=3-6*c/Math.PI,a=this.time.getHours()+this.time.getMinutes()/60+this.time.getSeconds()/3600,b+=b<a?24:0,b=((b<a+6?b:b<a+12?b-12:b<a+18?b+12:b)+24)%24,a=(60*(3-6*c/Math.PI)%60+60)%60;d=new Date;d.setHours(b);d.setMinutes(a);d.setSeconds((3600*(3-6*c/Math.PI)%60+60)%60);this.setTime(d)}};ClockSelector.prototype.setTimeRecurring=function(){var b=this;return function(){b.setTime(new Date)}};
ClockSelector.prototype.setTransform=function(b,a,c){b.setTransform(-c*Math.cos(a),-c*Math.sin(a),c*Math.sin(a),-c*Math.cos(a),100*c,100*c)};ClockSelector.prototype.makeEndDrag=function(){var b=this;return function(){b.color_minute=b.color_mindef;b.dragging=!1;b.setTime(b.clockTime())}};ClockSelector.prototype.makeSetTime=function(b){if(this.manual){var a=this;return function(){var c=window.event,d=a.getCanvasOffset(),e=c.pageX-d[0]-a.size/2,c=a.size/2-(c.pageY-d[1]);a.manual&&(a.canvas.style.cursor=
Math.sqrt(e*e+c*c)<=(a.size*a.scale_border+a.stroke_border)/2?"pointer":"default");if(a.dragging!=b){if(b&&!a.dragging){var d=30*(Math.atan2(e,c)+2*Math.PI)/Math.PI,f=[(d+57.5)%60,(d+2.5)%60],d=a.clockTime().getMinutes()+a.clockTime().getSeconds()/60;Math.sqrt(e*e+c*c)<a.size/2*a.scale_border&&(f[0]<d&&d<f[1]||d<f[0]&&f[1]<f[0]&&d<f[1]||f[0]<d&&f[1]<d&&f[1]<f[0])?a.color_minute!=a.highlight&&(a.color_minute=a.highlight,a.drag_minute=!0,a.setTime(a.clockTime())):a.color_minute!=a.color_mindef&&(a.color_minute=
a.color_mindef,a.drag_minute=!1,a.setTime(a.clockTime()))}}else a.dragging||b||(a.timeout&&(clearTimeout(a.timeout),a.timeout=null),a.dragging=!0),a.setTimeFromEvent(window.event)}}};this.manual&&(this.canvas.onmousedown=this.makeSetTime(!1),this.canvas.onmouseup=this.makeEndDrag(),this.canvas.onmouseout=this.makeEndDrag(),this.canvas.onmousemove=this.makeSetTime(!0));this.reset()};
